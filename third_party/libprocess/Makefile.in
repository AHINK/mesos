# Makefile.

SHELL = '/bin/sh'

CXX = @CXX@

CXXFLAGS = @CXXFLAGS@
LDFLAGS = @LDFLAGS@
LIBS = @LIBS@

BOOST = third_party/boost-1.37.0
GLOG = third_party/glog-0.3.1
LIBEV = third_party/libev-3.8
RY_HTTP_PARSER = third_party/ry-http-parser-1c3624a

# Get better debugging info.
CXXFLAGS += -g

# Add . to CXXFLAGS.
CXXFLAGS += -I@srcdir@

# Add libev to CXXFLAGS.
CXXFLAGS += -I@srcdir@/$(LIBEV)

# Add Boost to CXXFLAGS.
CXXFLAGS += -I@srcdir@/$(BOOST)

# Add http parser to CXXFLAGS.
CXXFLAGS += -I@srcdir@/$(RY_HTTP_PARSER)

# Add glog to include and lib paths.
CXXFLAGS += -I@srcdir@/$(GLOG)/src -I@builddir@/$(GLOG)/src
LDFLAGS += -L@builddir@/$(GLOG)/.libs

# Add -fPIC to CXXFLAGS.
CXXFLAGS += -fPIC -D_XOPEN_SOURCE

# Add dependency tracking to CXXFLAGS.
CXXFLAGS += -MMD -MP

LDFLAGS += -L. -L$(LIBEV)/.libs
LIBS += -lprocess -lglog -lev -lpthread

LIBPROCESS_OBJS = process.o pid.o fatal.o tokenize.o latch.o
LIBPROCESS_LIB = libprocess.a


default: all

-include $(patsubst %.o, %.d, $(LIBPROCESS_OBJS))

$(LIBPROCESS_OBJS): %.o: @srcdir@/%.cpp 
	$(CXX) $(CXXFLAGS) -c -o $@ $<

$(LIBPROCESS_LIB): $(LIBPROCESS_OBJS)
	$(AR) rcs $@ $^ $(RY_HTTP_PARSER)/http_parser_g.o

third_party:
	$(MAKE) -C $(GLOG)
	$(MAKE) -C @builddir@/$(LIBEV)
	cp -r @srcdir@/$(RY_HTTP_PARSER) @builddir@/third_party
	$(MAKE) -C @builddir@/$(RY_HTTP_PARSER) http_parser_g.o

all: third_party $(LIBPROCESS_LIB)

test: all
	$(CXX) $(CXXFLAGS) -o test @srcdir@/test.cpp $(LDFLAGS) $(LIBS)

clean:
	$(MAKE) -C $(GLOG) clean
	$(MAKE) -C @builddir@/$(LIBEV)
	$(MAKE) -C @builddir@/$(RY_HTTP_PARSER) clean
	rm -f $(patsubst %.o, %.d, $(LIBPROCESS_OBJS)) $(LIBPROCESS_OBJS) $(LIBPROCESS_LIB)

distclean: clean
	$(MAKE) -C $(GLOG) distclean
	$(MAKE) -C @builddir@/$(LIBEV) distclean
	rm -f config.status config.cache config.log
	rm -f Makefile

.PHONY: default third_party all clean
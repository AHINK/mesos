# Makefile.

SHELL = '/bin/sh'

CXX = @CXX@

CXXFLAGS = -g @CXXFLAGS@

# Add . to CXXFLAGS.
CXXFLAGS += -I@abs_srcdir@

# Add libev to CXXFLAGS.
CXXFLAGS += -I@abs_srcdir@/third_party/libev-3.8

# Add Boost to CXXFLAGS.
CXXFLAGS += -I@abs_srcdir@/third_party/boost-1.37.0

# Add http parser to CXXFLAGS.
CXXFLAGS += -I@abs_srcdir@/third_party/ry-http-parser-1c3624a

# Add -fPIC to CXXFLAGS.
CXXFLAGS += -fPIC -D_XOPEN_SOURCE

# Add dependency tracking to CXXFLAGS.
CXXFLAGS += -MMD -MP

LIB_OBJ = process.o pid.o fatal.o tokenize.o latch.o
LIB = libprocess.a

OBJS = $(LIB_OBJ)
LIBS = $(LIB)


default: all

-include $(patsubst %.o, %.d, $(OBJS))

$(LIB_OBJ): %.o: @abs_srcdir@/%.cpp 
	$(CXX) -c $(CXXFLAGS) -o $@ $<

$(LIB): $(LIB_OBJ)
	$(AR) rcs $@ $^ third_party/ry-http-parser-1c3624a/http_parser_g.o

third_party:
	$(MAKE) -C @abs_builddir@/third_party/libev-3.8
	cp -r @abs_srcdir@/third_party/ry-http-parser-1c3624a @abs_builddir@/third_party/
	$(MAKE) -C @abs_builddir@/third_party/ry-http-parser-1c3624a http_parser_g.o

all: third_party $(LIBS)

clean:
	$(MAKE) -C @abs_builddir@/third_party/libev-3.8 clean
	rm -f $(patsubst %.o, %.d, $(OBJS)) $(OBJS) $(LIBS)

distclean: clean
	$(MAKE) -C @abs_builddir@/third_party/libev-3.8 dist clean
	rm -f config.status config.cache config.log
	rm -f Makefile

.PHONY: default third_party all clean